<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! trunk/opendj3/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011 ForgeRock AS
  !    
-->
<chapter xml:id='chap-extended-ops'
 xmlns='http://docbook.org/ns/docbook' version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Working With Extended Operations</title>

 <para>This chapter demonstrates how to use LDAP extended operations.</para>

 <section xml:id="about-ldap-extended-operations">
  <title>About LDAP Extended Operations</title>
  <para>Extended operations allow additional operations to be defined for
  services not already available in the protocol</para>
 </section>
 
 <section xml:id="get-supported-extended-operations">
  <title>Determining Supported Extended Operations</title>

  <para>For OpenDJ, the extended operations supported are listed in the
  <citetitle>Administration Guide</citetitle> appendix, <link
  xlink:href="admin-guide#appendix-extended-ops"
  xlink:role="http://docbook.org/xlink/role/olink"><citetitle>LDAP Extended
  Operations</citetitle></link>. You can access the list of OIDs for
  supported LDAP controls by reading the <literal>supportedExtension</literal>
  attribute of the root DSE.</para>

  <screen>$ ldapsearch
 --baseDN ""
 --searchScope base
 --port 1389
 "(objectclass=*)" supportedExtension
dn: 
supportedExtension: 1.3.6.1.1.8
supportedExtension: 1.3.6.1.4.1.26027.1.6.1
supportedExtension: 1.3.6.1.4.1.26027.1.6.2
supportedExtension: 1.3.6.1.4.1.26027.1.6.3
supportedExtension: 1.3.6.1.4.1.4203.1.11.1
supportedExtension: 1.3.6.1.4.1.4203.1.11.3
supportedExtension: 1.3.6.1.4.1.1466.20037</screen>

  <para>The following excerpt shows code to check for supported extended
  operations.</para>

  <programlisting language="java">
/**
 * Controls supported by the LDAP server.
 */
private static Collection&lt;String&gt; extendedOperations;

/**
 * Populate the list of supported LDAP extended operation OIDs.
 * 
 * @param connection
 *            Active connection to the LDAP server.
 * @throws ErrorResultException
 *             Failed to get list of extended operations.
 */
static void checkSupportedExtendedOperations(Connection connection)
        throws ErrorResultException {
    extendedOperations = RootDSE.readRootDSE(connection)
            .getSupportedExtendedOperations();
}

/**
 * Check whether an extended operation is supported. Call
 * {@code checkSupportedExtendedOperations} first.
 * 
 * @param extendedOperation
 *            Check support for this extended operation, provided by OID.
 * @return True if the control is supported.
 */
static boolean isSupported(final String extendedOperation) {
    if (extendedOperations != null &amp;&amp; !extendedOperations.isEmpty()) {
        return extendedOperations.contains(extendedOperation);
    }
    return false;
}
</programlisting>
 </section>
 
 <section xml:id="use-cancel-extended-operation">
  <title>Cancel Extended Operation</title>

  <para>RFC 3909, <link xlink:href="http://tools.ietf.org/html/rfc3909"
  xlink:show="new"><citetitle>LDAP Cancel Operation</citetitle></link>, defines
  an extended operation that lets you cancel an operation in progress and get
  an indication of the outcome.</para>

  <para>This cancel extended requests uses the request ID of operation you
  want to cancel, and so therefore works with asynchronous searches and
  updates.</para>

  <programlisting language="java">
TODO
</programlisting>

  <para>OpenDJ directory server supports the cancel operation.</para>

  <programlisting>TODO</programlisting>
 </section>

 <section xml:id="use-password-modify-extended-operation">
  <title>Password Modify Extended Operation</title>

  <para>RFC 3062, <link xlink:href="http://tools.ietf.org/html/rfc3062"
  xlink:show="new"><citetitle>LDAP Password Modify Extended
  Operation</citetitle></link>, defines an extended operation for modifying
  user passwords that does not depend on the authentication identity, nor on
  the way passwords are stored.</para>

  <programlisting language="java">
if (isSupported(PasswordModifyExtendedRequest.OID)) {
    final String userIdentity = "u:scarter";
    final char[] oldPassword = "sprain".toCharArray();
    final char[] newPassword = "secret12".toCharArray();

    final PasswordModifyExtendedRequest request =
            Requests.newPasswordModifyExtendedRequest()
                .setUserIdentity(userIdentity)
                .setOldPassword(oldPassword)
                .setNewPassword(newPassword);

    final PasswordModifyExtendedResult result =
            connection.extendedRequest(request);
    if (result.isSuccess()) {
        System.out.println("Changed password for " + userIdentity);
    } else {
        System.err.println(result.getDiagnosticMessage());
    }
}
</programlisting>

  <para>OpenDJ directory server supports the password modify operation.</para>

  <programlisting>Changed password for u:scarter</programlisting>
 </section>

 <section xml:id="use-starttls-extended-operation">
  <title>Start TLS Extended Operation</title>

  <para>Use Start TLS when setting up your connection to protect what your
  application sends to and receives from the directory server. For an example,
  read the section on <link
  xlink:href="dev-guide#simple-auth-with-starttls-or-ssl"
  xlink:role="http://docbook.org/xlink/role/olink"><citetitle>Start TLS &amp;
  SSL Authentication</citetitle></link>.</para>
 </section>

 <section xml:id="use-who-am-i-extended-operation">
  <title>Who am I? Extended Operation</title>

  <para>RFC 4532, <link xlink:href="http://tools.ietf.org/html/rfc4532"
  xlink:show="new"><citetitle>LDAP "Who am I?" Operation</citetitle></link>,
  defines an extended operation that lets your application determine the
  current authorization ID.</para>

  <programlisting language="java">
if (isSupported(WhoAmIExtendedRequest.OID)) {

    final String name = "uid=bjensen,ou=People,dc=example,dc=com";
    final char[] password = "hifalutin".toCharArray();

    final Result result = connection.bind(name, password);
    if (result.isSuccess()) {

        final WhoAmIExtendedRequest request =
                Requests.newWhoAmIExtendedRequest();
        final WhoAmIExtendedResult extResult =
                connection.extendedRequest(request);

        if (extResult.isSuccess()) {
            System.out.println("Authz ID: "  + extResult.getAuthorizationID());
        }
    }
}
</programlisting>

  <para>OpenDJ directory server supports the "Who am I?" operation.</para>

  <programlisting
  >Authz ID: dn:uid=bjensen,ou=People,dc=example,dc=com</programlisting>
 </section>

 <section xml:id="custom-extended-operation">
  <title>Custom Extended Operations</title>

  <para>TODO</para>
 </section>
</chapter>

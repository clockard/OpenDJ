<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! trunk/opendj3/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011 ForgeRock AS
  !    
-->
<chapter xml:id='chap-backup-restore'
 xmlns='http://docbook.org/ns/docbook' version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Backing Up &amp; Restoring Data</title>

 <para>OpenDJ lets you backup and restore your data either in compressed,
 binary format, or in LDAP Data Interchange Format. This chapter shows you how
 to backup and to restore OpenDJ data from archives, and explains portability
 of backup archives, as well as backing up server configuration
 information.</para>
 
 <section xml:id="backup">
  <title>Backing Up Directory Data</title>
  <indexterm><primary>Backup</primary></indexterm>
  <para>A <filename>bak/</filename> directory is provided when you install
  OpenDJ, as a location to save binary backups. When you create a backup,
  the <filename>bak/backup.info</filename> contains information about the
  archive.</para>
  
  <para>Archives produced by the <command>backup</command> command contain
  backups only of the directory data. Backups of server configuration are
  found in <filename>config/archived-configs/</filename>.</para>
 
  <procedure xml:id="backup-immediately">
   <title>To Back Up Data Immediately</title>
   
   <step>
    <para>Use one of the following alternatives.</para>
    <stepalternatives>
     <step>
      <para>Back up only the database for Example.com, where the data
      is stored in the backend named <literal>userRoot</literal>.</para>
      <screen>$ backup -p 5444 -D "cn=Directory Manager" -w password
 -n userRoot -d /path/to/OpenDJ/bak -t 0
Backup task 20110613143715983 scheduled to start Jun 13, 2011 2:37:15 PM CEST</screen>
     </step>
     <step>
      <para>Stop the server to back up Example.com data offline.</para>
      <screen>$ stop-ds 
Stopping Server...

[13/Jun/2011:14:31:00 +0200] category=BACKEND severity=NOTICE msgID=9896306
 msg=The backend userRoot is now taken offline
[13/Jun/2011:14:31:00 +0200] category=CORE severity=NOTICE msgID=458955
 msg=The Directory Server is now stopped
$ backup -n userRoot -d /path/to/OpenDJ/bak
[13/Jun/2011:14:33:48 +0200] category=TOOLS severity=NOTICE msgID=10944792
 msg=Starting backup for backend userRoot
[13/Jun/2011:14:33:48 +0200] category=JEB severity=NOTICE msgID=8847446
 msg=Archived: 00000000.jdb
[13/Jun/2011:14:33:48 +0200] category=TOOLS severity=NOTICE msgID=10944795
 msg=The backup process completed successfully
$ start-ds
... The Directory Server has started successfully</screen>
     </step>
     <step>
      <para>Back up all user data on the server.</para>
      <screen>$ backup -p 5444 -D "cn=Directory Manager" -w password
 -a -d /path/to/OpenDJ/bak -t 0
Backup task 20110613143801866 scheduled to start Jun 13, 2011 2:38:01 PM CEST</screen>
     </step>
    </stepalternatives>
   </step>
  </procedure>
  
  <procedure xml:id="schedule-backup">
   <title>To Schedule Data Backup</title>
   
   <para>You can schedule data backup using <command>crontab</command>
   format.</para>
   
   <step>
    <para>Back up all user data every night at 2 AM, and notify
    diradmin@example.com when finished, or on error.</para>
    <screen>$ backup -p 5444 -D "cn=Directory Manager" -w password -a
 -d /path/to/OpenDJ/bak --recurringTask "00 02 * * *"
 --completionNotify diradmin@example.com --errorNotify diradmin@example.com
Recurring Backup task BackupTask-988d6adf-4d65-44bf-8546-6ea74a2480b0
scheduled successfully</screen>
   </step>
  </procedure>
 </section>

 <section xml:id="restore-data">
  <title>Restoring Directory Data From Backup</title>
  <indexterm><primary>Backup</primary></indexterm>
  <indexterm>
   <primary>Restoring</primary>
   <secondary>From backup</secondary>
  </indexterm>
  
  <para>When you restore data, the procedure to follow depends on whether
  the OpenDJ directory server is replicated.</para>
  
  <procedure xml:id="restore-standalone-server">
   <title>To Restore a Stand-alone Server</title>
  
   <step>
    <para>Use one of the following alternatives.</para>
    <stepalternatives>
     <step>
      <para>Stop the server to restore data for Example.com.</para>
      <screen>$ stop-ds
Stopping Server...

[13/Jun/2011:15:44:06 +0200] category=BACKEND severity=NOTICE msgID=9896306
 msg=The backend userRoot is now taken offline
[13/Jun/2011:15:44:06 +0200] category=CORE severity=NOTICE msgID=458955
 msg=The Directory Server is now stopped
$ restore -d /path/to/OpenDJ/bak -l
Backup ID:          20110613080032
Backup Date:        13/Jun/2011:08:00:45 +0200
Is Incremental:     false
Is Compressed:      false
Is Encrypted:       false
Has Unsigned Hash:  false
Has Signed Hash:    false
Dependent Upon:     none
$ restore -d /path/to/OpenDJ/bak -I 20110613080032
[13/Jun/2011:15:47:41 +0200] category=JEB severity=NOTICE msgID=8847445
 msg=Restored: 00000000.jdb (size 341835)
$ start-ds
... The Directory Server has started successfully</screen>
     </step>
     <step>
      <para>Schedule the restore as a task to begin immediately.</para>
      <screen>$ restore -p 5444 -D "cn=Directory Manager" -w password
 -d /path/to/OpenDJ/bak -I 20110613080032 -t 0
Restore task 20110613155052932 scheduled to start Jun 13, 2011 3:50:52 PM CEST</screen>
     </step>
    </stepalternatives>
   </step>
  </procedure>
  
  <procedure xml:id="restore-replica">
   <title>To Restore a Replica</title>
   <indexterm>
    <primary>Replication</primary>
    <secondary>Restoring from backup</secondary>
   </indexterm>
   
   <para>When you restore a replicated server from backup, make sure the
   backup is newer than the last purge of the replication change log (default:
   3 days).</para>
   
   <step>
    <para>Prepare the replica to be restored.</para>
    <screen>$ dsreplication pre-external-initialization -I admin -w password -X -n
 -p 5444 -b dc=example,dc=com

Preparing base DN dc=example,dc=com to be initialized externally ..... Done.

Now you can proceed to the initialization of the contents of the base DN's
 on all the replicated servers.  You can use the command import-ldif or
 the binary copy to do so.  You must use the same LDIF file or binary copy
 on each server.

When the initialization is completed you must use the subcommand
 'post-external-initialization' for replication to work with the new
 base DN's contents.</screen>
   </step>
   <step>
    <para>Restore the server database from the backup archive.</para>
    <screen>$ stop-ds
Stopping Server...

[13/Jun/2011:15:44:06 +0200] category=BACKEND severity=NOTICE msgID=9896306
 msg=The backend userRoot is now taken offline
[13/Jun/2011:15:44:06 +0200] category=CORE severity=NOTICE msgID=458955
 msg=The Directory Server is now stopped
$ restore -d /path/to/OpenDJ/bak -l
Backup ID:          20110613080032
Backup Date:        13/Jun/2011:08:00:45 +0200
Is Incremental:     false
Is Compressed:      false
Is Encrypted:       false
Has Unsigned Hash:  false
Has Signed Hash:    false
Dependent Upon:     none
$ restore -d /path/to/OpenDJ/bak -I 20110613080032
[13/Jun/2011:15:47:41 +0200] category=JEB severity=NOTICE msgID=8847445
 msg=Restored: 00000000.jdb (size 341835)
$ start-ds
... The Directory Server has started successfully</screen>
   </step>
   <step>
    <para>Reinitialize replication on the replica.</para>
    <screen>$ dsreplication post-external-initialization -I admin -w password -X -n
 -p 5444 -b dc=example,dc=com

Updating replication information on base DN dc=example,dc=com ..... Done.

Post initialization procedure completed successfully.</screen>
   </step>
  </procedure>
 </section>
</chapter>
